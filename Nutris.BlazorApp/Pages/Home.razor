@page "/home"
@inject IAuthService AuthService
@inject ILocalizationService Localization
@inject NavigationManager Navigation
@inject ILocalStorageService LocalStorage
@implements IDisposable
<link href="/css/Home.css" rel="stylesheet" />
<link href="/css/fonts.css" rel="stylesheet" />

<PageTitle>Home - Nutris</PageTitle>

<!-- Language Selector -->
<div class="language-selector-home">
    <button class="language-button" type="button" @onclick="ToggleLanguageMenu">
        @if (currentLanguage == "es")
        {
            <span>Español</span>
        }
        else
        {
            <span>English</span>
        }
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" />
        </svg>
    </button>

    @if (showLanguageMenu)
    {
        <div class="language-dropdown">
            <button class="dropdown-item" type="button" @onclick="@(() => SelectLanguage("en"))">
                English
            </button>
            <button class="dropdown-item" type="button" @onclick="@(() => SelectLanguage("es"))">
                Español
            </button>
        </div>
    }
</div>

<!-- Home Content con Slideshow -->
<div class="main-content" id="home">
    <!-- Slideshow de imágenes -->
    <div class="slideshow-container">
        @for (int i = 1; i <= 5; i++)
        {
            var imageIndex = i;
            <div class="slide @(currentImageIndex == imageIndex ? "active" : "")"
                 style="background-image: url('/img/@(imageIndex).avif');">
            </div>
        }
    </div>

    <!-- Indicadores opcionales -->
    <div class="slideshow-indicators">
        @for (int i = 1; i <= 5; i++)
        {
            var imageIndex = i;
            <span class="indicator @(currentImageIndex == imageIndex ? "active" : "")"
                  @onclick="() => GoToSlide(imageIndex)"></span>
        }
    </div>

    <!-- Texto superpuesto -->
    <div class="text-home">
        <h1 class="font-82 MuseoSemiBold">@Localization["Home.Welcome"]</h1>
        <div class="pagraph-home font-20 RalewayRegular">
            <span>@Localization["Home.Text1"]</span>
            <span>@Localization["Home.Text2"]</span>
            <span>@Localization["Home.Text3"]</span>
            <span>@Localization["Home.Text4"]</span>
        </div>
    </div>
</div>

@code {
    private bool showLanguageMenu = false;
    private string currentLanguage = "en";
    private int currentImageIndex;
    private System.Threading.Timer? slideshowTimer;
    private const int TOTAL_SLIDES = 5;
    private Random random = new Random();

    protected override async Task OnInitializedAsync()
    {
        // Verificar autenticación
        var isAuthenticated = await AuthService.IsAuthenticatedAsync();
        if (!isAuthenticated)
        {
            Navigation.NavigateTo("/");
            return;
        }

        // Obtener idioma actual
        currentLanguage = Localization.CurrentLanguage ?? "en";

        // Suscribirse a cambios de idioma
        Localization.OnLanguageChanged += OnLanguageChanged;

        // Iniciar con una imagen aleatoria
        currentImageIndex = random.Next(1, TOTAL_SLIDES + 1); // Genera un número entre 1 y 5

        // Iniciar el slideshow
        StartSlideshow();
    }

    private void StartSlideshow()
    {
        slideshowTimer = new System.Threading.Timer(
            callback: _ => NextSlide(),
            state: null,
            dueTime: TimeSpan.FromSeconds(5), // Primera transición después de 5 segundos
            period: TimeSpan.FromSeconds(5)   // Cambiar cada 5 segundos
        );
    }

    private void NextSlide()
    {
        InvokeAsync(() =>
        {
            currentImageIndex++;
            if (currentImageIndex > TOTAL_SLIDES)
            {
                currentImageIndex = 1;
            }
            StateHasChanged();
        });
    }

    private void GoToSlide(int index)
    {
        currentImageIndex = index;

        // Reiniciar el timer cuando el usuario selecciona manualmente una imagen
        slideshowTimer?.Dispose();
        StartSlideshow();
    }

    private void OnLanguageChanged()
    {
        currentLanguage = Localization.CurrentLanguage;
        InvokeAsync(StateHasChanged);
    }

    private void ToggleLanguageMenu()
    {
        showLanguageMenu = !showLanguageMenu;
    }

    private async Task SelectLanguage(string language)
    {
        showLanguageMenu = false;
        await Localization.ChangeLanguageAsync(language);
    }

    public void Dispose()
    {
        Localization.OnLanguageChanged -= OnLanguageChanged;
        slideshowTimer?.Dispose();
    }
}