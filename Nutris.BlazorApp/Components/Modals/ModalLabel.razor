@namespace NutrisBlazor.Components.Modals
@page "/components/modals/label"
@using System.Text.Json
@using Microsoft.AspNetCore.Components.Forms
@using NutrisBlazor.Components.Shared
@using NutrisBlazor.Models
@inject ILocalizationService Localization
@inject IJSRuntime JSRuntime
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ILogger<ModalLabel> Logger
@inject IApiService ApiService
<link href="css/ModalLabel.css" rel="stylesheet" />
@if (!isLoading)
{
    <div class="modal sidebar-right fade modal-overlay @(IsVisible ? "show d-block" : "")"
         id="sidebarRightModal2"
         tabindex="-1"
         aria-labelledby="sidebarRightModal"
         style="@(IsVisible ? "display: block;" : "display: none;")">
        <div class="modal-dialog modal-dialog-sidebar modal-dialog-right">
            <div class="modal-content">
                <div class="modal_header justify-content-end">
                    <button type="button" class="b-close" @onclick="CloseModal">
                        <img class="btn-close"
                             aria-label="Close"
                             src="img/close-x.svg"
                             alt="" />
                    </button>
                </div>

                <div class="modal-body">
                    <div class="modal-body_header">
                        <h2 class="modal-title font-32 modal-container-title MuseoSemiBold mb-2">
                            @Localization["orderView.Label"]
                        </h2>
                    </div>

                    <div class="tabs-inline">
                        <section id="content1" class="content-bottle">
                            <div class="parent-label">
                                <div class="child-bottles-form">
                                    <h3 class="child-bottle-title_features font-24 RalewaySemiBold">
                                        @Localization["modalLabel.Characteristics"]
                                    </h3>

                                    <!-- Primera fila: Maximum Size y Color -->
                                    <div class="child_content_features-bottle-form">
                                        <!-- Maximum Size (izquierda) -->
                                        <div class="form-grup-input-field RalewayRegular">
                                            <label class="form-group-label-size" for="size">
                                                @Localization["modalLabel.Maximumsize"]
                                            </label>
                                            <select class="form-select-config Museo size-select"
                                                    @bind="labelSize"
                                                    @bind:after="FetchPdfOnSizeChange"
                                                    disabled>
                                                <option value="">Select Size</option>
                                                @foreach (var optionMX in OptionsSizeLabel)
                                                {
                                                    <option value="@optionMX.Value">@optionMX.Value</option>
                                                }
                                            </select>
                                        </div>

                                        <!-- Color (derecha) -->
                                        <div class="form-grup-input-field">
                                            <label class="form-group-label-size" for="color">
                                                @Localization["modalContainer.Color"]
                                            </label>
                                            <select class="form-select-config Museo"
                                                    @bind="labelColors">
                                                <option value="">Select Type</option>
                                                @foreach (var optionC in OptionsColorLabel)
                                                {
                                                    <option value="@optionC.Value">@optionC.Value</option>
                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Segunda fila: Material y Finish -->
                                    <div class="child_content_features-bottle-form">
                                        <!-- Material (izquierda) -->
                                        <div class="form-grup-input-field">
                                            <label class="form-group-label-size" for="material">
                                                @Localization["modalContainer.Material"]
                                            </label>
                                            <select class="form-select-config Museo"
                                                    @bind="labelMaterial">
                                                <option value="">Select Material</option>
                                                @foreach (var optionLM in OptionsLabelMaterial)
                                                {
                                                    <option value="@optionLM.Value">@optionLM.Value</option>
                                                }
                                            </select>
                                        </div>

                                        <!-- Finish (derecha) -->
                                        <div class="form-grup-input-field">
                                            <label class="form-group-label-size" for="finish">
                                                @Localization["modalLabel.Finish"]
                                            </label>
                                            <select class="form-select-config Museo"
                                                    @bind="labelFinish">
                                                <option value="">Select Finish</option>
                                                @foreach (var optionF in OptionsFinish)
                                                {
                                                    <option value="@optionF.Value">@optionF.Value</option>
                                                }
                                            </select>
                                        </div>
                                    </div>

                                    <!-- Download PDF Section -->
                                    <div class="container-download-file">
                                        <div class="container-download-file-button">
                                            @if (!string.IsNullOrEmpty(pdfDownloadUrl))
                                            {
                                                <a href="@pdfDownloadUrl"
                                                   download="troquel-@(labelSize).pdf"
                                                   class="container-donload-file-text"
                                                   style="cursor:pointer; display:inline-block;"
                                                   target="_blank">
                                                    <img src="img/arrow-d.svg" alt="download" /><br />
                                                    @Localization["ModalLabel.Downloadsample"]
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="child_content_info-bottle-label">
                                    <!-- Draft Label Section -->
                                    <div class="chil_content_info_upload">
                                        <span class="child_content-label-info-title font-24 RalewayMedium">
                                            @Localization["ModalLabel.DraftLabel"]
                                        </span>
                                        
                                        <div class="child_content-label-button">
                                            <InputFile id="fileInput"
                                                       class="visually-hidden child_content-label-button-upload"
                                                       accept="image/*"
                                                       OnChange="HandleFileUpload" />
                                        </div>
                                        
                                        <label for="fileInput" class="upload-content-btn2">
                                            @if (string.IsNullOrEmpty(previewImage))
                                            {
                                                <div class="img-btn-upload">
                                                    <span class="child_content-label-button-upload font-20 RalewayBold">
                                                        @Localization["ModalLabel.UploadDraftVersion"]
                                                    </span>
                                                    <span class="RalewayRegular font-20">
                                                        @Localization["ModalLabel.Nofileuploadyet"]
                                                    </span>
                                                </div>
                                            }
                                            else
                                            {
                                                <div class="preview-container">
                                                    <img src="@previewImage" 
                                                         alt="Preview" 
                                                         class="preview-image" 
                                                         style="width: 100px;">
                                                </div>
                                                
                                                <div class="paragraph-upload">
                                                    <button class="btn-save-atr-upload"
                                                            @onclick="UpdatedDraftLabel"
                                                            disabled="@(string.IsNullOrEmpty(previewImage) || isLoading)">
                                                        @if (isLoading)
                                                        {
                                                            <Loading />
                                                        }
                                                        else
                                                        {
                                                            <span>@Localization["Upload"]</span>
                                                        }
                                                    </button>
                                                </div>
                                            }
                                        </label>
                                        
                                        <div class="border-doted"></div>
                                    </div>
                                    
                                    <!-- Final Label Section -->
                                    <div class="chil_content_info_upload mt-2">
                                        <span class="child_content-label-info-title font-24 RalewayMedium">
                                            @Localization["ModalLabel.FinalLabel"]
                                        </span>

                                        @if (!string.IsNullOrEmpty(FinalImagen))
                                        {
                                            <div class="final-label-actions">
                                                <span @onclick="DownloadImage"
                                                      class="child_content-label-button-upload cursor-pointer font-20 RalewayBold">
                                                    @Localization["ModalLabel.DownloadLabel"]
                                                </span>

                                                <span class="RalewayRegular font-20">
                                                    @Localization["ModalLabel.finalLabelmessage"]
                                                </span>
                                            </div>
                                        }
                                        else
                                        {
                                            <div>
                                                <span class="RalewayRegular font-20">
                                                    @Localization["ModalLabel.finalLabelmessageNot"]
                                                </span>
                                            </div>
                                        }

                                    </div>
                                </div>
                            </div>
                        </section>
                    </div>

                    <div class="modal-footer-bts">
                        <button @onclick="CloseModal"
                                class="modal-footer-btc-cancel RalewayBold font-20"
                                disabled="@isLoading">
                            @Localization["NavBar.Cancel"]
                        </button>
                        <button class="modal-footer-btc-save RalewayBold font-20"
                                @onclick="UpdateSelectedOption"
                                disabled="@isLoading">
                            @if (isLoading)
                            {
                                <span class="spinner-label"></span>
                                <span>Guardando...</span>
                            }
                            else
                            {
                                @Localization["NavBar.Save"]
                            }
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {

    // Parameters
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    [Parameter] public string CodeRG35 { get; set; } = "";
    [Parameter] public string FinalImagen { get; set; } = "";

    [Parameter] public List<OptionMX> OptionsSizeLabel { get; set; } = new();
    [Parameter] public List<Option> OptionsFinish { get; set; } = new();
    [Parameter] public List<Option> OptionsLabelMaterial { get; set; } = new();
    [Parameter] public List<Option> OptionsColorLabel { get; set; } = new();
    [Parameter] public SelectedLabelOptions? SelectedOptionLabels { get; set; }
    [Parameter] public EventCallback<LabelOptionsUpdatedEventArgs> OnLabelOptionsUpdated { get; set; }
    [Parameter] public EventCallback<DraftLabelUpdatedEventArgs> OnDraftLabelUpdated { get; set; }
    public class DraftLabelUpdatedEventArgs
    {
        public string? Base64 { get; set; }
        public string? ContentType { get; set; }  // ej: "image/png"
        public string? DataUrl =>
            string.IsNullOrEmpty(Base64)
                ? null
                : $"data:{(string.IsNullOrEmpty(ContentType) ? "image/png" : ContentType)};base64,{Base64}";
    }
    // State variables
    private bool isLoading = false;
    private string? previewImage = null;
    private string? base64Data = null;
    private string? pdfDownloadUrl = null;
    private long maxFileSize = 10 * 1024 * 1024; // 10MB
    private string? uploadedContentType;
    // Form fields
    private string labelSize = "";
    private string labelMaterial = "";
    private string labelFinish = "";
    private string labelColors = "";

    protected override async Task OnInitializedAsync()
    {
        if (SelectedOptionLabels != null)
        {
            labelSize = SelectedOptionLabels.LabelSize ?? "";
            labelMaterial = SelectedOptionLabels.LabelMaterial ?? "";
            labelFinish = SelectedOptionLabels.LabelFinish ?? "";
            labelColors = SelectedOptionLabels.LabelColors ?? "";

            if (!string.IsNullOrEmpty(labelSize))
                await FetchPdfOnSizeChange();
        }
    }

    protected override async Task OnParametersSetAsync()
    {
        // Update when parameters change
        if (SelectedOptionLabels != null)
        {
            labelSize = SelectedOptionLabels.LabelSize ?? "";
            labelMaterial = SelectedOptionLabels.LabelMaterial ?? "";
            labelFinish = SelectedOptionLabels.LabelFinish ?? "";
            labelColors = SelectedOptionLabels.LabelColors ?? "";

            if (!string.IsNullOrEmpty(labelSize))
                await FetchPdfOnSizeChange();
        }
    }

    private async Task FetchPdfOnSizeChange()
    {
        var response = await ApiService.PostAsync2("troquelPDF(1)/Microsoft.NAV.Download?tenant=nutris", new { numeroTroquel = labelSize }
);

        if (response.IsSuccessStatusCode)
        {
            var responseContent = await response.Content.ReadAsStringAsync();

            string? base64 = null;
            using var jsonDoc = JsonDocument.Parse(responseContent);

            // OData actual (como en Vue): { "value": "..." }
            if (jsonDoc.RootElement.TryGetProperty("value", out var valueEl))
                base64 = valueEl.GetString();
            // fallback por si viene anidado: { "data": { "value": "..." } }
            else if (jsonDoc.RootElement.TryGetProperty("data", out var dataEl) &&
                     dataEl.TryGetProperty("value", out var nestedVal))
                base64 = nestedVal.GetString();

            if (!string.IsNullOrWhiteSpace(base64))
            {
                if (base64.StartsWith("data:application/pdf;base64,", StringComparison.OrdinalIgnoreCase))
                    base64 = base64.Substring("data:application/pdf;base64,".Length);
                base64 = base64.Replace(" ", "").Replace("\n", "").Replace("\r", "");

                pdfDownloadUrl = await CreateBlobUrl(base64, "application/pdf");
            }
            else
            {
                pdfDownloadUrl = null;
            }
        }
        else
        {
            pdfDownloadUrl = null;
        }

    }

    private async Task<string> CreateBlobUrl(string base64, string mimeType)
    {
        var url = await JSRuntime.InvokeAsync<string>("createBlobUrl", base64, mimeType);
        return url;
    }

    private async Task HandleFileUpload(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;

            // Validate file type
            if (!file.ContentType.StartsWith("image/"))
            {
                await ShowAlert(Localization["Pleaseselectavalidimagefile"]);
                return;
            }

            // Validate file size
            if (file.Size > maxFileSize)
            {
                await ShowAlert($"File size must be less than {maxFileSize / (1024 * 1024)}MB");
                return;
            }

            // Read file and convert to base64
            using var stream = file.OpenReadStream(maxFileSize);
            using var memoryStream = new MemoryStream();
            await stream.CopyToAsync(memoryStream);
            var bytes = memoryStream.ToArray();
            uploadedContentType = file.ContentType; // NUEVO
            // Create base64 string
            base64Data = Convert.ToBase64String(bytes);
            previewImage = $"data:{file.ContentType};base64,{base64Data}";

            StateHasChanged();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error uploading file");
            await ShowAlert("Error uploading file. Please try again.");
            previewImage = null;
            base64Data = null;
        }
    }

    private async Task UpdateSelectedOption()
    {

        isLoading = true;
        await Task.Delay(500); // Allow UI to update

        StateHasChanged();

     
        var data = new
        {
            Label_size = labelSize,
            Label_material = labelMaterial,
            Label_finish = labelFinish,
            Label_type = labelColors
        };

        Logger.LogInformation("Updating label options with data: {@Data}", data);

        try
        {
            var response = await ApiService.PatchAsync($"CustomizeRG35('{CodeRG35}')?$expand=Formulation,Recipe,Analytics&tenant=nutris",data);

            if (response.IsSuccessStatusCode)
            {
                var responseContent = await response.Content.ReadAsStringAsync();
                Logger.LogInformation("Label options updated successfully");

                // Emit event to parent component
                var eventData = new LabelOptionsUpdatedEventArgs
                {
                    Response = responseContent,
                    SentData = data
                };
                
                await OnLabelOptionsUpdated.InvokeAsync(eventData);
                if (!string.IsNullOrEmpty(base64Data))
                    await OnDraftLabelUpdated.InvokeAsync(new DraftLabelUpdatedEventArgs { Base64 = base64Data, ContentType = uploadedContentType });

                // Close modal after delay
                await Task.Delay(500);
                await CloseModal();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError("API error response: {Error}", errorContent);
                await ShowAlert("Error updating label options. Please try again.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating label options");
            await ShowAlert("An error occurred. Please try again.");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

 

    private async Task UpdatedDraftLabel()
    {
        if (string.IsNullOrEmpty(base64Data)) { await ShowAlert("Please select an image first"); return; }
        isLoading = true; StateHasChanged();

        var data = new { numeroRG = CodeRG35, tipoImagen = "Label_imagen", imagenBase64 = base64Data };
        try
        {
            var response = await ApiService.PostAsync2("modificarImagen(1)/Microsoft.NAV.modificarCab?tenant=nutris", data);

            if (response.IsSuccessStatusCode)
            {
                // 👉 Notifica al padre con lo que ACABAS de subir
                await OnDraftLabelUpdated.InvokeAsync(new DraftLabelUpdatedEventArgs
                {
                    Base64 = base64Data,
                    ContentType = uploadedContentType
                });

                await Task.Delay(300);
                await CloseModal();
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogError("API error response: {Error}", errorContent);
                await ShowAlert("Error updating draft label. Please try again.");
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error updating draft label");
            await ShowAlert("An error occurred. Please try again.");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }


    private async Task DownloadImage()
    {
        if (string.IsNullOrEmpty(FinalImagen))
        {
            await ShowAlert("No image available to download");
            return;
        }

        try
        {
            // Create download link using JavaScript
            await JSRuntime.InvokeVoidAsync("downloadBase64File", 
                FinalImagen, 
                $"Label-Imagen-{CodeRG35}.png",
                "image/png");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading image");
            await ShowAlert("Error downloading image. Please try again.");
        }
    }

    private async Task CloseModal()
    {
        // Clean up blob URL if exists
        if (!string.IsNullOrEmpty(pdfDownloadUrl))
        {
           await JSRuntime.InvokeVoidAsync("revokeBlobUrl", pdfDownloadUrl);
            pdfDownloadUrl = null;
        }
        
        // Reset state
        previewImage = null;
        base64Data = null;
        
        // Notify parent component
        await OnClose.InvokeAsync();
        
        // Hide Bootstrap modal if needed
        await JSRuntime.InvokeVoidAsync("hideBootstrapModal", "sidebarRightModal2");
    }

    private async Task ShowAlert(string message)
    {
        await JSRuntime.InvokeVoidAsync("alert", message);
    }

    // Data models
    public class OptionMX
    {
        public int ID { get; set; }
        public string Value { get; set; } = "";
        public string Imagen { get; set; } = "";
    }

    public class Option
    {
        public int ID { get; set; }
        public string Value { get; set; } = "";
    }

    public class SelectedLabelOptions
    {
        public string? LabelSize { get; set; }
        public string? LabelMaterial { get; set; }
        public string? LabelFinish { get; set; }
        public string? LabelColors { get; set; }
    }

    public class LabelOptionsUpdatedEventArgs
    {
        public object? Response { get; set; }
        public object? SentData { get; set; }
    }
}

<style>
    .visually-hidden {
        position: absolute !important;
        width: 1px !important;
        height: 1px !important;
        padding: 0 !important;
        margin: -1px !important;
        overflow: hidden !important;
        clip: rect(0,0,0,0) !important;
        white-space: nowrap !important;
        border: 0 !important;
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    /* Spinner para el botón save */
    .spinner-label {
        display: inline-block;
        width: 14px;
        height: 14px;
        margin-right: 8px;
        vertical-align: middle;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: #ffffff;
        border-radius: 50%;
        animation: spinner-rotate 0.8s linear infinite;
    }

    @@keyframes spinner-rotate {
        to

    {
        transform: rotate(360deg);
    }

    }

    /* Mantener el estilo del botón cuando está deshabilitado */
    .modal-footer-btc-save {
        min-width: 120px;
        min-height: 48px;
        position: relative;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        transition: opacity 0.3s ease;
    }

        .modal-footer-btc-save:disabled {
            /* Busca el color original de tu botón Save y reemplaza #007bff con ese color */
            background-color: #007bff !important; /* Mantener el color original */
            opacity: 0.8;
            cursor: not-allowed;
            pointer-events: none;
        }

            /* Prevenir cambios de hover cuando está deshabilitado */
            .modal-footer-btc-save:disabled:hover {
                transform: none !important;
            }

    /* Botón cancelar deshabilitado */
    .modal-footer-btc-cancel:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<script>
    // Add these JavaScript functions to your main layout or a shared JS file
    window.createBlobUrl = (base64, mimeType) => {
        const byteCharacters = atob(base64);
        const byteNumbers = new Array(byteCharacters.length);
        for (let i = 0; i < byteCharacters.length; i++) {
            byteNumbers[i] = byteCharacters.charCodeAt(i);
        }
        const byteArray = new Uint8Array(byteNumbers);
        const blob = new Blob([byteArray], { type: mimeType });
        return URL.createObjectURL(blob);
    };
    
    window.downloadBase64File = (base64Data, fileName, mimeType) => {
        const link = document.createElement('a');
        link.href = base64Data.startsWith('data:') ? base64Data : `data:${mimeType};base64,${base64Data}`;
        link.download = fileName;
        link.click();
    };
    
    window.hideBootstrapModal = (modalId) => {
        const modal = document.getElementById(modalId);
        if (modal) {
            const bootstrapModal = bootstrap.Modal.getInstance(modal);
            if (bootstrapModal) {
                bootstrapModal.hide();
            }
        }
    };
      window.revokeBlobUrl = (url) => { try { URL.revokeObjectURL(url); } catch(e){} }

</script>
